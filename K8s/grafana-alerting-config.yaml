apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerting-config
  namespace: monitoring
  labels:
    grafana_alert: "1"
data:
  contactpoints.yaml: |
    apiVersion: 1
    contactPoints:
      - orgId: 1
        name: Discord
        receivers:
          - uid: discord-webhook
            type: discord
            settings:
              url: "https://discord.com/api/webhooks/1461244083396939818/yxDW5aWDeGrBdxMrbxtmGWbYCiU5ktd7NhR_230IA11T42HDWr0uN5GM13MvtczaXc2n"
              use_discord_username: true
              message: |
                ğŸš¨ **{{ .CommonLabels.alertname }}**

                ğŸ“‹ **ìƒíƒœ:** {{ .Status }}
                ğŸ·ï¸ **ì‹¬ê°ë„:** {{ .CommonLabels.severity }}
                â° **ë°œìƒ ì‹œê°„:** {{ .CommonAnnotations.startsAt }}

                ğŸ“ **ë‚´ìš©:** {{ .CommonAnnotations.description }}

                ğŸ”— [Grafana ëŒ€ì‹œë³´ë“œ](http://a29ec3a7fd21b4dd58f8b2b9a5c12b70-2128802671.ap-northeast-2.elb.amazonaws.com:3000)
            disableResolveMessage: false
  policies.yaml: |
    apiVersion: 1
    policies:
      - orgId: 1
        receiver: Discord
        group_by: ['alertname']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
  rules.yaml: |
    apiVersion: 1
    groups:
      - orgId: 1
        name: ETL Pipeline Alerts
        folder: alerts
        interval: 1m
        rules:
          - uid: error-rate-alert
            title: ì—ëŸ¬ìœ¨ ë†’ìŒ
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: clickhouse
                model:
                  rawSql: "SELECT max(error_rate) as error_rate FROM logs.metrics_server_health_minutely WHERE minute >= now() - INTERVAL 5 MINUTE"
                  format: table
              - refId: C
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: A
                  conditions:
                    - evaluator:
                        type: gt
                        params: [0.05]
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "ì—ëŸ¬ìœ¨ì´ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
              description: "í˜„ì¬ ì—ëŸ¬ìœ¨ì´ ì„ê³„ì¹˜(5%)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
          - uid: dau-low-alert
            title: DAU ë‚®ìŒ
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 86400
                  to: 0
                datasourceUid: clickhouse
                model:
                  rawSql: "SELECT unique_users FROM logs.metrics_business_daily WHERE date = today() AND metric_kind = 'ACTION' ORDER BY unique_users DESC LIMIT 1"
                  format: table
              - refId: C
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: A
                  conditions:
                    - evaluator:
                        type: lt
                        params: [1000]
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "DAUê°€ 1000ëª… ë¯¸ë§Œì…ë‹ˆë‹¤"
              description: "ì˜¤ëŠ˜ í™œì„± ì‚¬ìš©ì ìˆ˜ê°€ 1000ëª… ë¯¸ë§Œì…ë‹ˆë‹¤."
          - uid: data-delay-alert
            title: ë°ì´í„° ìˆ˜ì§‘ ì§€ì—°
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 600
                  to: 0
                datasourceUid: clickhouse
                model:
                  rawSql: "SELECT max(avg_delay_seconds) as delay FROM logs.metrics_server_health_minutely WHERE minute >= now() - INTERVAL 10 MINUTE"
                  format: table
              - refId: C
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: A
                  conditions:
                    - evaluator:
                        type: gt
                        params: [300]
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "ë°ì´í„° ìˆ˜ì§‘ì´ 5ë¶„ ì´ìƒ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤"
              description: "ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì§€ì—°ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Spark ì‘ì—…ì„ í™•ì¸í•˜ì„¸ìš”."
          - uid: no-data-alert
            title: ë°ì´í„° ë¯¸ìˆ˜ì§‘
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 600
                  to: 0
                datasourceUid: clickhouse
                model:
                  rawSql: "SELECT count(*) as cnt FROM logs.metrics_server_health_minutely WHERE minute >= now() - INTERVAL 10 MINUTE"
                  format: table
              - refId: C
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: A
                  conditions:
                    - evaluator:
                        type: lt
                        params: [1]
            for: 10m
            labels:
              severity: critical
            annotations:
              summary: "10ë¶„ê°„ ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
              description: "íŒŒì´í”„ë¼ì¸ì´ ì¤‘ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Kafka, Spark, MinIO ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
